#!/bin/bash

add-apt-repository ppa:charmers/charm-helpers

apt-get update && apt-get -y upgrade
apt-get -y install mysql-client pwgen nginx php5 php5-fpm php-apc mailutils php-mail sysstat php5-mysql php5-mcrypt charm-helper-sh s3cmd php5-curl

rm -f /etc/cron.d/php5
mv files/apc.ini /etc/php5/conf.d/

mkdir -p /mnt/tmp
chmod 1777 /mnt/tmp

rm -f /etc/nginx/sites-enabled/*
install -o root -g root -m 0644 files/nginx-omg /etc/nginx/sites-enabled/omg

rm -f /etc/php5/fpm/pool.d/*
install -o root -g root -m 0644 files/omg-php5-fpm.pool.d /etc/php5/fpm/pool.d/www.conf

rm -f /etc/nginx/sites-available/loadbalancer
install -o root -g root -m 0644 files/nginx-loadbalancer /etc/nginx/sites-available/loadbalancer
ln -sf ../sites-available/loadbalancer /etc/nginx/sites-enabled/loadbalancer

service php5-fpm restart
service nginx restart

juju-log "So, environment is setup. We'll wait for some hooks to fire off before we get all crazy"
